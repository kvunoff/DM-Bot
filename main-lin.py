import secrets
import telebot
from telebot import types
import sys
import os
import mss
import mss.tools
import subprocess
import time
import imageio
import numpy as np
import requests
from requests.exceptions import ConnectionError, ReadTimeout
import hashlib
import json
import tempfile
import pyautogui
import importlib.util

TOKEN = ""
TOKEN_INITIALIZED = False
USER_DATA_FILE = os.path.join(os.path.expanduser("~"), ".dm_bot", "user_data.json")
bot = None
VIDEO_RECORDING = False
ACCESS_CODE_TIMEOUT = 60
AUTHORIZED_USERS = {}
ACCESS_CODES = {}

def check_video_dependencies():
    try:
        importlib.import_module('imageio.plugins.ffmpeg')
        return True
    except ImportError:
        return False

def install_video_dependencies():
    try:
        subprocess.check_call([sys.executable, "-m", "pip", "install", "imageio[ffmpeg]"])
        return True
    except subprocess.CalledProcessError:
        return False

def ensure_config_dir():
    config_dir = os.path.dirname(USER_DATA_FILE)
    if not os.path.exists(config_dir):
        os.makedirs(config_dir)

def generate_access_code():
    random_string = secrets.token_hex(16)
    hashed_code = hashlib.sha256(random_string.encode()).hexdigest()
    return hashed_code, random_string

def verify_access_code(telegram_id, user_input):
    try:
        hashed_code, random_string = ACCESS_CODES[telegram_id]
    except KeyError:
        return False

    input_hashed_code = hashlib.sha256(user_input.encode()).hexdigest()
    return input_hashed_code == hashed_code

def clear_access_code(telegram_id):
    try:
        del ACCESS_CODES[telegram_id]
    except KeyError:
        pass

def load_user_data():
    global AUTHORIZED_USERS
    ensure_config_dir()
    try:
        with open(USER_DATA_FILE, "r") as f:
            AUTHORIZED_USERS = json.load(f)
    except FileNotFoundError:
        AUTHORIZED_USERS = {}
    except json.JSONDecodeError:
        print("–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞ user_data.json. –§–∞–π–ª –±—É–¥–µ—Ç –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞–Ω.")
        AUTHORIZED_USERS = {}

def save_user_data():
    try:
        with open(USER_DATA_FILE, "w") as f:
            json.dump(AUTHORIZED_USERS, f)
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {e}")

load_user_data()

def is_authorized(telegram_id):
    return AUTHORIZED_USERS.get(str(telegram_id), False)

def take_screenshot():
    try:
        with mss.mss() as sct:
            sct_img = sct.grab(sct.monitors[1])
            output = os.path.join(tempfile.gettempdir(), "screenshot.png")
            mss.tools.to_png(sct_img.rgb, sct_img.size, output=output)
            return output, None
    except Exception as e:
        return None, f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–∫—Ä–∏–Ω—à–æ—Ç–∞: {e}"

def send_screenshot(message):
    screenshot_file, error_message = take_screenshot()
    if error_message:
        bot.send_message(message.chat.id, error_message)
        return
    if screenshot_file:
        try:
            with open(screenshot_file, "rb") as photo:
                bot.send_photo(message.chat.id, photo)
        except FileNotFoundError:
            bot.send_message(message.chat.id, "–û—à–∏–±–∫–∞: –§–∞–π–ª —Å–∫—Ä–∏–Ω—à–æ—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω.")
        except Exception as e:
            bot.send_message(message.chat.id, f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–∫—Ä–∏–Ω—à–æ—Ç–∞: {e}")
        finally:
            try:
                os.remove(screenshot_file)
            except Exception as e:
                print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞: {e}")
    else:
        bot.send_message(message.chat.id, "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–¥–µ–ª–∞—Ç—å —Å–∫—Ä–∏–Ω—à–æ—Ç.")

def record_screen(duration=10):
    global VIDEO_RECORDING
    VIDEO_RECORDING = True

    if not check_video_dependencies():
        if not install_video_dependencies():
            return None, "–î–ª—è –∑–∞–ø–∏—Å–∏ –≤–∏–¥–µ–æ —Ç—Ä–µ–±—É–µ—Ç—Å—è —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É: pip install imageio[ffmpeg]"

    filename = os.path.join(tempfile.gettempdir(), "screen_record.mp4")
    try:
        with mss.mss() as sct:
            monitor = sct.monitors[1]
            width = monitor["width"]
            height = monitor["height"]

            writer = imageio.get_writer(filename, fps=20)

            start_time = time.time()
            while time.time() - start_time < duration and VIDEO_RECORDING:
                img = sct.grab(monitor)
                frame = np.array(img)

                if frame.shape[2] == 4:
                    frame = frame[:, :, [2, 1, 0, 3]]
                elif frame.shape[2] == 3:
                    frame = frame[:, :, [2, 1, 0]]

                writer.append_data(frame)

            writer.close()
        return filename, None
    except Exception as e:
        return None, f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø–∏—Å–∏ –≤–∏–¥–µ–æ: {e}"
    finally:
        VIDEO_RECORDING = False

def send_video(message):
    video_file, error_message = record_screen()
    if error_message:
        bot.send_message(message.chat.id, error_message)
        return

    if video_file:
        try:
            with open(video_file, "rb") as video:
                bot.send_video(message.chat.id, video)
        except FileNotFoundError:
            bot.send_message(message.chat.id, "–û—à–∏–±–∫–∞: –§–∞–π–ª –≤–∏–¥–µ–æ –Ω–µ –Ω–∞–π–¥–µ–Ω.")
        except Exception as e:
            bot.send_message(message.chat.id, f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –≤–∏–¥–µ–æ: {e}")
        finally:
            try:
                os.remove(video_file)
            except Exception as e:
                print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞: {e}")
    else:
        bot.send_message(message.chat.id, "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø–∏—Å–∞—Ç—å –≤–∏–¥–µ–æ.")

def shutdown_pc():
    try:
        subprocess.run(["shutdown", "-h", "now"])
        return "–ü–ö –≤—ã–∫–ª—é—á–∞–µ—Ç—Å—è..."
    except Exception as e:
        return f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–∫–ª—é—á–µ–Ω–∏–∏ –ü–ö: {e}"

def lock_pc(message):
    try:
        subprocess.run(["xdg-screensaver", "lock"])
        bot.send_message(message.chat.id, "–ü–ö –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω!")
    except Exception as e:
        bot.send_message(message.chat.id, f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–µ –ü–ö: {e}")

def authorized(func):
    def wrapper(message):
        telegram_id = str(message.from_user.id)

        if not is_authorized(telegram_id):
            if bot:
                bot.reply_to(message, "–í—ã –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –¥–æ—Å—Ç—É–ø–∞, –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã–π –≤ –∫–æ–Ω—Å–æ–ª–∏.")
                send_access_code_request(message)
            else:
                print("–ë–æ—Ç –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —Ç–æ–∫–µ–Ω.")
            return

        return func(message)

    return wrapper

def start(message):
    telegram_id = str(message.from_user.id)

    if not is_authorized(telegram_id):
        if bot:
            bot.reply_to(message, "–í—ã –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –¥–æ—Å—Ç—É–ø–∞, –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã–π –≤ –∫–æ–Ω—Å–æ–ª–∏.")
            send_access_code_request(message)
        else:
            print("–ë–æ—Ç –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —Ç–æ–∫–µ–Ω.")
        return

    show_main_menu(message)
    send_hello_message(message)

def send_access_code_request(message):
    telegram_id = str(message.from_user.id)
    hashed_code, random_string = generate_access_code()
    ACCESS_CODES[telegram_id] = (hashed_code, random_string)
    
    print(f"\n–ö–æ–¥ –¥–æ—Å—Ç—É–ø–∞: {random_string}")
    print("–í–≤–µ–¥–∏—Ç–µ —ç—Ç–æ—Ç –∫–æ–¥ –≤ Telegram –±–æ—Ç–∞ –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏.")
    print("–ö–æ–¥ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω –≤ —Ç–µ—á–µ–Ω–∏–µ 60 —Å–µ–∫—É–Ω–¥.\n")
    
    bot.send_message(message.chat.id, "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –¥–æ—Å—Ç—É–ø–∞, –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã–π –≤ –∫–æ–Ω—Å–æ–ª–∏.")

def process_access_code(message, telegram_id):
    user_input = message.text.strip()
    
    if verify_access_code(telegram_id, user_input):
        AUTHORIZED_USERS[telegram_id] = True
        save_user_data()
        clear_access_code(telegram_id)
        bot.reply_to(message, "–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!")
        show_main_menu(message)
    else:
        bot.reply_to(message, "–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥ –¥–æ—Å—Ç—É–ø–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.")
        send_access_code_request(message)

def show_main_menu(message):
    markup = types.ReplyKeyboardMarkup(resize_keyboard=True)
    buttons = [
        types.KeyboardButton("üì∏ –°–¥–µ–ª–∞—Ç—å —Å–∫—Ä–∏–Ω—à–æ—Ç"),
        types.KeyboardButton("üé• –ó–∞–ø–∏—Å–∞—Ç—å –≤–∏–¥–µ–æ"),
        types.KeyboardButton("üîí –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ü–ö"),
        types.KeyboardButton("üîÑ –í—ã–∫–ª—é—á–∏—Ç—å –ü–ö"),
        types.KeyboardButton("üóë –û—á–∏—Å—Ç–∏—Ç—å –¥–∞–Ω–Ω—ã–µ")
    ]
    markup.add(*buttons)
    bot.send_message(message.chat.id, "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:", reply_markup=markup)

def send_hello_message(message):
    bot.send_message(message.chat.id, "–ü—Ä–∏–≤–µ—Ç! –Ø –±–æ—Ç –¥–ª—è —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–æ–º–ø—å—é—Ç–µ—Ä–æ–º.")

def clear_user_data(message):
    telegram_id = str(message.from_user.id)
    if telegram_id in AUTHORIZED_USERS:
        del AUTHORIZED_USERS[telegram_id]
        save_user_data()
        bot.reply_to(message, "–î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —É–¥–∞–ª–µ–Ω—ã.")
    else:
        bot.reply_to(message, "–î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.")

@authorized
def lock_pc_button(message):
    lock_pc(message)

@authorized
def screenshot_button(message):
    send_screenshot(message)

@authorized
def video_button(message):
    send_video(message)

@authorized
def shutdown_button(message):
    result = shutdown_pc()
    bot.send_message(message.chat.id, result)

@authorized
def clear_data_button(message):
    clear_user_data(message)

def register_handlers():
    bot.message_handler(commands=['start'])(start)
    bot.message_handler(func=lambda message: message.text == "üì∏ –°–¥–µ–ª–∞—Ç—å —Å–∫—Ä–∏–Ω—à–æ—Ç")(screenshot_button)
    bot.message_handler(func=lambda message: message.text == "üé• –ó–∞–ø–∏—Å–∞—Ç—å –≤–∏–¥–µ–æ")(video_button)
    bot.message_handler(func=lambda message: message.text == "üîí –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ü–ö")(lock_pc_button)
    bot.message_handler(func=lambda message: message.text == "üîÑ –í—ã–∫–ª—é—á–∏—Ç—å –ü–ö")(shutdown_button)
    bot.message_handler(func=lambda message: message.text == "üóë –û—á–∏—Å—Ç–∏—Ç—å –¥–∞–Ω–Ω—ã–µ")(clear_data_button)
    
    @bot.message_handler(func=lambda message: True)
    def handle_messages(message):
        telegram_id = str(message.from_user.id)
        if telegram_id in ACCESS_CODES:
            process_access_code(message, telegram_id)
        else:
            bot.reply_to(message, "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º–µ–Ω—é –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è.")

def run_bot():
    global bot, TOKEN
    while not TOKEN:
        print("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —Ç–æ–∫–µ–Ω –≤–∞—à–µ–≥–æ –±–æ—Ç–∞:")
        TOKEN = input().strip()
    
    bot = telebot.TeleBot(TOKEN)
    register_handlers()
    print("\n–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω! –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /start –≤ Telegram –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã.")
    print("–î–ª—è –≤—ã—Ö–æ–¥–∞ –Ω–∞–∂–º–∏—Ç–µ Ctrl+C\n")
    bot.polling(none_stop=True)

if __name__ == "__main__":
    try:
        run_bot()
    except KeyboardInterrupt:
        print("\n–ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.") 
